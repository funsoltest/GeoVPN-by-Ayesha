from appium import webdriver
from appium.options.android import UiAutomator2Options
from appium.webdriver.common.appiumby import AppiumBy
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from appium.webdriver.common.appiumby import AppiumBy
from selenium.common.exceptions import TimeoutException
import time
import sys

options = UiAutomator2Options()
options.platform_name = "Android"
options.automation_name = "UiAutomator2"
options.app_package = "com.fast.secure.proxyvpn.unlimitedproxy.security"
options.app_activity = "com.example.safevpn.ui.activity.MainActivity"
options.no_reset = True
print("Connecting to Appium server...")
driver = webdriver.Remote("http://127.0.0.1:4723", options=options)
print("App launched successfully!")

driver.activate_app("com.fast.secure.proxyvpn.unlimitedproxy.security")
print("App forced to foreground")
try:
    accept_button = driver.find_element(AppiumBy.ANDROID_UIAUTOMATOR,
                                        'new UiSelector().text("Accept & Continue")')
    accept_button.click()
    print("Clicked 'Accept and Continue'")
except:
    print("Accept & Continue button not found, must be 2nd or onward session")
WebDriverWait(driver, 10).until(
        EC.presence_of_element_located(
            (AppiumBy.ID,
             "com.fast.secure.proxyvpn.unlimitedproxy.security:id/vpn_on_off_icon")
        )
    )
driver.execute_script('mobile:pressKey', {"keycode": 4})
print("Back pressed...")
try:
    wait = WebDriverWait(driver, 2)
    cancel_button = wait.until(
    EC.presence_of_element_located((AppiumBy.ID, "com.fast.secure.proxyvpn.unlimitedproxy.security:id/card_cancel")))
    cancel_button.click()
    print("Cancel button clicked")
except:
    print("Could not find cancel button.")
    Tap_to_exit_button = wait.until(
    EC.presence_of_element_located((AppiumBy.ID, "com.fast.secure.proxyvpn.unlimitedproxy.security:id/exit_tv_card")))
    Tap_to_exit_button.click()
    driver.quit()
    print("Execution stopped")
    sys.exit(0)

WebDriverWait(driver, 2).until(
        EC.presence_of_element_located(
            (AppiumBy.ID,
             "com.fast.secure.proxyvpn.unlimitedproxy.security:id/vpn_on_off_icon")
        )
    )
driver.execute_script('mobile:pressKey', {"keycode": 4})
print("Back pressed...")
EXIT_BUTTON = [ (AppiumBy.ID, "com.fast.secure.proxyvpn.unlimitedproxy.security:id/exit_tv_card"),
                (AppiumBy.ID, "com.fast.secure.proxyvpn.unlimitedproxy.security:id/card_exit"), 
                (AppiumBy.ID, "new UiSelector().text(\"Exit\")") 
            ]
for by, locator in EXIT_BUTTON:
        try:
            wait = WebDriverWait(driver, 2)

            element = wait.until(EC.presence_of_element_located((by, locator)))
            element.click()
            print(f"Clicked VPN toggle: {locator}")
            vpn_clicked = True
            break
        except TimeoutException:
            print(f"Not found: {locator}")
print("Test completed!")
driver.quit()
