from appium import webdriver
from appium.options.android import UiAutomator2Options
from appium.webdriver.common.appiumby import AppiumBy
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from appium.webdriver.common.appiumby import AppiumBy
from selenium.common.exceptions import TimeoutException
import time

options = UiAutomator2Options()
options.platform_name = "Android"
options.automation_name = "UiAutomator2"

options.app_package = "com.fast.secure.proxyvpn.unlimitedproxy.security"
options.app_activity = "com.example.safevpn.ui.activity.MainActivity"
options.no_reset = True


print("Connecting to Appium server...")
driver = webdriver.Remote("http://127.0.0.1:4723", options=options)
print("Session created")

driver.activate_app("com.fast.secure.proxyvpn.unlimitedproxy.security")
print("App forced to foreground")

print("App launched successfully!")
wait = WebDriverWait(driver, 20)

try:
    accept_button = driver.find_element(AppiumBy.ANDROID_UIAUTOMATOR,
                                        'new UiSelector().text("Accept & Continue")')
    accept_button.click()
    print("Clicked 'Accept and Continue'")
except:
    print("Accept & Continue button not found, it is 2nd or onward session")

wait = WebDriverWait(driver, 20)

print("Checking current VPN state...")

already_connected = True
try:
    WebDriverWait(driver, 5).until(
        EC.presence_of_element_located(
            (AppiumBy.ANDROID_UIAUTOMATOR,
             'new UiSelector().textContains("Tap to Connect")')
        )
    )
    already_connected = False
    print("VPN is already disconnected")
except TimeoutException:
    print("VPN is connected, proceeding to disconnect")

VPN_TOGGLE_ELEMENTS = [ (AppiumBy.ID, "com.fast.secure.proxyvpn.unlimitedproxy.security:id/inner_circle_view"),
                        (AppiumBy.ID, "com.fast.secure.proxyvpn.unlimitedproxy.security:id/connectionStatus"), 
                        (AppiumBy.ID, "com.fast.secure.proxyvpn.unlimitedproxy.security:id/vpn_on_off_icon") 
                    ]

if already_connected:
    print("VPN is connected, disconnecting...")

    vpn_clicked = False
    for by, locator in VPN_TOGGLE_ELEMENTS:
        try:
            element = wait.until(EC.presence_of_element_located((by, locator)))
            element.click()
            print(f"Clicked VPN toggle: {locator}")
            vpn_clicked = True
            break
        except TimeoutException:
            continue

    if not vpn_clicked:
        raise Exception("❌ No VPN toggle element found")

    try:
        cancel_button = WebDriverWait(driver, 5).until(
            EC.presence_of_element_located(
                (AppiumBy.ID, "com.fast.secure.proxyvpn.unlimitedproxy.security:id/cancel10")
            )
        )
        cancel_button.click()
        print("Cancel clicked")
    except TimeoutException:
        print("No cancel dialog")

    try:
        tap_to_disconnect = WebDriverWait(driver, 5).until(
            EC.presence_of_element_located(
                (AppiumBy.ID, "com.fast.secure.proxyvpn.unlimitedproxy.security:id/connectionStatus")
            )
        )
        tap_to_disconnect.click()
        print("Tap to Disconnect clicked")
    except TimeoutException:
        print("Disconnect text not found")

    try:
        disconnect_button = WebDriverWait(driver, 5).until(
            EC.presence_of_element_located(
                (AppiumBy.ID, "com.fast.secure.proxyvpn.unlimitedproxy.security:id/endSession")
            )
        )
        disconnect_button.click()
        print("Disconnect button clicked")
    except TimeoutException:
        print("Disconnect confirmation not shown")

    driver.press_keycode(4)
    WebDriverWait(driver, 20).until(
        EC.presence_of_element_located(
            (AppiumBy.ANDROID_UIAUTOMATOR,
             'new UiSelector().textContains("Tap to Connect")')
        )
    )

    print("✅ VPN Disconnected successfully")

else:
    print("✅ VPN already disconnected, skipping disconnect flow")


print("Test completed!")

driver.terminate_app("com.fast.secure.proxyvpn.unlimitedproxy.security")
print("App terminated")

driver.quit()